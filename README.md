# Privacy-Preserving Identity Verification using zk-SNARKs and ERC-735 (M.Tech Project)

This project demonstrates a system for verifying user identity attributes (like age) in a decentralized manner without revealing the underlying data. It utilizes Zero-Knowledge proofs (zk-SNARKs with Groth16) generated using Circom and integrates with blockchain identity concepts potentially compatible with ERC-735.

## Features

*   **Zero-Knowledge Proofs:** Verifies attribute properties (e.g., age > 18) without disclosing the actual attribute value.
*   **EdDSA Signature Verification:** Includes optional verification of an issuer's signature on the original data within the ZK proof.
*   **Circom:** Uses Circom for defining the arithmetic circuits for the ZK proofs.
*   **SnarkJS:** Used for the trusted setup, witness generation, and proof generation.
*   **Hardhat:** Ethereum development environment used for compiling, deploying, and interacting with smart contracts (written in TypeScript).
*   **Smart Contracts:** Includes an example `AttributeRegistrySig` contract to store verified attribute commitments and a `Verifier` contract for on-chain proof verification.

## Project Structure

```
├── bash_Scripts/        # Helper bash scripts for workflow steps
│   ├── prepareInput.sh
│   ├── witness.sh
│   ├── generateProof.sh
│   └── check_issuer_params.sh (Optional validation)
├── build/               # Output: Circom artifacts (r1cs, wasm), ZK keys (ptau, zkey), witness, proof (IGNORED BY GIT)
├── contracts/           # Solidity smart contracts
│   ├── AttributeRegistrySig.sol
│   └── VerifierSig.sol  (Generated by snarkjs)
├── issuer_output/       # Output from issuer simulation (keys, params - Potentially IGNORED BY GIT)
├── scripts/             # Node.js/TypeScript helper scripts & Hardhat deploy script
│   ├── issuer_actions.cjs             # (or .ts) Simulates issuer generating keys/signature
│   ├── generate_random_inputs_iden3.cjs # (or .ts) Generates all inputs randomly
│   ├── deploy.cjs                   # (or .ts) Hardhat deployment script
├── tasks/               # Hardhat tasks
│   └── addClaimTask.cjs             # (or .ts) Task to submit claim/proof
├── circuits/            # Circom circuits source code
│   └── ProveCommitmentWithSignature.circom
├── node_modules/        # Project dependencies (IGNORED BY GIT)
├── .env.example         # Example environment file (Copy to .env and fill)
├── .gitignore           # Specifies intentionally untracked files by Git
├── hardhat.config.cjs   # (or .ts) Hardhat configuration
├── package.json
├── tsconfig.json        # TypeScript configuration
└── README.md            # This file
```

## Prerequisites

*   **Node.js:** v18.x LTS recommended (check `.nvmrc` if present or install manually)
*   **NVM (Node Version Manager):** Recommended for managing Node.js versions.
*   **npm or yarn:** Node package manager.
*   **jq:** Command-line JSON processor (used in some bash scripts): `brew install jq` or `sudo apt install jq`.
*   **Circom Compiler:** Installed globally (`npm install -g circom`).
*   **SnarkJS:** Installed globally (`npm install -g snarkjs`).

## Setup

1.  **Clone Repository:**
    ```bash
    git clone <your-repo-url>
    cd <your-repo-directory>
    ```

2.  **Install Node.js Version:**
    ```bash
    # If using NVM and .nvmrc file exists:
    nvm install
    nvm use
    # Or manually install/use Node v18:
    # nvm install 18
    # nvm use 18
    ```

3.  **Install Dependencies:**
    ```bash
    npm install
    # Or: yarn install
    ```

4.  **Powers of Tau File:**
    *   Download a Powers of Tau file (`.ptau`) from a completed ceremony (e.g., Hermez/Polygon Hermez or Perpetual Powers of Tau). For *testing only*, a small insecure one can sometimes be generated during setup scripts, but **do not use this for production**.
    *   Place the downloaded `.ptau` file in the project's root directory (e.g., rename it to `pot12_final.ptau`). The scripts expect this filename.

5.  **Environment Variables:**
    *   Copy the example environment file: `cp .env.example .env`
    *   Edit the `.env` file and add your Ethereum wallet private key (for testnets) and RPC URLs (e.g., from Infura/Alchemy) if you plan to deploy to a network other than the local Hardhat node.
    ```dotenv
    # .env
    SEPOLIA_RPC_URL="https://sepolia.infura.io/v3/YOUR_PROJECT_ID"
    TESTNET_PRIVATE_KEY="0xYOUR_PRIVATE_KEY"
    ```
    **IMPORTANT:** `.env` is listed in `.gitignore` and should NEVER be committed.

## Workflow Steps

Follow these steps in order. Most steps involve running bash scripts which orchestrate Node.js/snarkjs/Hardhat commands. Ensure each step completes successfully before proceeding.

**Step 1: Simulate Issuer (Generate Keys, Signature, Params)**
   *   Generates EdDSA keys, certificate data, hashes, signs, and creates `issuer_output/params_for_user.json`.
    ```bash
    # Ensure dependencies are installed
    # If issuer_actions uses TS: npx ts-node scripts/issuer_actions.ts
    # If issuer_actions uses CJS: node scripts/issuer_actions.cjs
    node scripts/issuer_actions.cjs # Or relevant command for your setup
    ```

**Step 2: Circom Compile & Trusted Setup**
   *   Compiles the Circom circuit.
   *   Performs the Groth16 trusted setup using the `.ptau` file.
   *   Generates the final proving key (`_final.zkey`) and verification key (`verification_key.json`) in `build/`.
   *   Generates the Solidity Verifier contract (`contracts/VerifierSig.sol`).
    ```bash
    # This script performs multiple snarkjs commands
    ./bash_Scripts/setupCircuit.sh # You might need to create/combine commands into this script
    # --- OR --- run commands manually/from previous steps:
    # 1. Compile
    #    mkdir -p build ...
    #    circom circuits/ProveCommitmentWithSignature.circom --r1cs --wasm --sym -o build
    # 2. Setup
    #    snarkjs groth16 setup build/ProveCommitmentWithSignature.r1cs pot12_final.ptau build/ProveCommitmentWithSignature_0000.zkey
    #    snarkjs zkey contribute build/ProveCommitmentWithSignature_0000.zkey build/ProveCommitmentWithSignature_final.zkey --name="Test" -v -e="random"
    #    snarkjs zkey export verificationkey build/ProveCommitmentWithSignature_final.zkey build/verification_key.json
    # 3. Export Verifier Contract
    #    snarkjs zkey export solidityverifier build/ProveCommitmentWithSignature_final.zkey contracts/VerifierSig.sol
    # 4. !!! IMPORTANT: Fix pragma/name inside contracts/VerifierSig.sol if needed !!!
    ```
    *(Note: You should consolidate the commands for Step 2 into a single script like `setupCircuit.sh` for convenience).*

**Step 3: Deploy Smart Contracts**
   *   Compiles Solidity contracts using Hardhat.
   *   Deploys `VerifierSig.sol` and `AttributeRegistrySig.sol` to the specified network.
   *   Runs the optional issuer registration step.
   *   Saves deployed addresses to `deployed_addresses.json`.
    ```bash
    # Start local node first if deploying to localhost
    # npx hardhat node &

    # Set network
    NETWORK_NAME=localhost # Or sepolia, etc.

    # Deploy (uses Hardhat's TS/JS runner)
    npx hardhat run scripts/deploy.cjs --network $NETWORK_NAME # Or deploy.ts
    ```

**Step 4: User Generates ZK Proof (Off-Chain)**
   *   **4.1 Prepare `input.json`:** Reads issuer parameters, generates a user salt, calculates commitment hash, and writes `build/input.json`.
        ```bash
        # This script runs the Node.js script to generate the input file
        ./bash_Scripts/prepareInput.sh
        ```
   *   **4.2 Generate Witness:** Calculates the witness based on the circuit and `input.json`. Creates `build/witness.wtns`.
        ```bash
        ./bash_Scripts/witness.sh
        ```
   *   **4.3 Generate Proof:** Creates the final ZK proof (`build/proof.json`) and public inputs (`build/public.json`).
        ```bash
        ./bash_Scripts/generateProof.sh
        ```

**Step 5: User Adds Claim On-Chain**
   *   Runs the Hardhat task `add-claim` which reads the proof/public files and sends a transaction to the deployed `AttributeRegistrySig` contract.
    ```bash
    # Read registry address from deployment output
    REGISTRY_ADDRESS=$(jq -r '.registry' deployed_addresses.json)
    ATTRIBUTE_NAME="age" # Choose the attribute name
    NETWORK_NAME=localhost # Must match deployment network

    # Run the task
    npx hardhat add-claim \
      --registry "$REGISTRY_ADDRESS" \
      --name "$ATTRIBUTE_NAME" \
      --network "$NETWORK_NAME"
    ```

**Step 6: Verification (Optional)**
   *   Run a script or Hardhat test to call `getClaim` on the registry contract to verify the claim was successfully stored.

## Cleaning Up

```bash
# Remove compiled artifacts and cache
npx hardhat clean

# Remove build outputs (ZK keys, witness, proof)
rm -rf build/

# Remove issuer simulation output
rm -rf issuer_output/

# Remove deployment state
rm -f deployed_addresses.json
```

## Troubleshooting

*   **`ERR_UNKNOWN_FILE_EXTENSION`:** Usually due to conflict between `package.json` `"type": "module"` and trying to run `.ts` files directly with `node` or Hardhat not using `ts-node` correctly. Fix by renaming Hardhat files to `.cjs` and using `require` syntax inside them, or configuring `tsconfig.json` + `ts-node` properly for ESM.
*   **`Cannot find module ...`:** Node.js cannot find the specified file. Check paths and spelling. For Hardhat types (`hardhat/types`), try `import ... from "hardhat";` instead.
*   **`TypeScript errors (TS...)`:** Fix errors reported by `npx tsc --noEmit` often related to `tsconfig.json` settings (`target`, `module`, `esModuleInterop`, `skipLibCheck`) or type mismatches in your `.ts` files.
*   **`ZK Assert Failed` (Witness Calculation):** Cryptographic inconsistency between inputs in `input.json`. Double-check signature, public key, and especially the `messageHash` consistency between issuer and user steps. Add off-chain verification debug steps. Try simplifying message hashing (Keccak->Split->Poseidon).
*   **`Issuer public key not registered` (Contract Revert):** Data inconsistency. Ensure the issuer public key registered during deployment matches the one used to generate the proof being submitted. Re-run the workflow cleanly without regenerating issuer keys mid-way. Ensure the Hardhat node wasn't restarted between deployment and submitting the claim. Add logging to contract functions (`registerIssuer`, `addClaim`) to compare public key hashes being used.
*   **`offset is out of bounds` / `Cannot convert BigInt` (Library Errors):** Likely internal bugs or incompatibilities in `circomlibjs`/`ffjavascript`. Try Node v18 LTS. Check library GitHub issues. Try the minimal signing test. Consider alternative signing libraries.

## Contributing

[Add contribution guidelines if applicable]

## License

[Add license information, e.g., MIT]